# -*- coding: utf-8 -*-
"""4th_ExtractingTEMPdataforAll_236_btwSepsisOnset_ShockOnsetPlus10h_or_SepsisOnsetPlus41h_Patients_LessThan20%Missing.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1PV1gfVfU5zx7mc0oOcCzTWlODMxY8ZZw
"""

# Commented out IPython magic to ensure Python compatibility.
import io
import pandas as pd
from IPython.display import display
import matplotlib.pyplot as plt
# %matplotlib inline
import numpy as np
import os
import shutil
import posixpath
import datetime
import psycopg2

"""To extract TEMPERATURE DATA for all sepsis patients that have time overlap for sepsis onset and shock onset timme OR sepsis onset time + 31 hours (all patietns with less and more than 20% missing values)"""

df_csvdata = pd.read_csv('/Users/safiya.hashmi/MasterThesis/CSV files generated/Only_AllSepsisPatients_with_MissingData_FromSepsisOnset_ToShockOnsetPlus10h_or_SepsisOnset+41h.csv')
# Dataset is now stored in a Pandas Dataframe
print ('shape of original dataframe from CSV : ', df_csvdata.shape)

df_sepsisOnset_SepsisOnsetPlus31h_csvdata = df_csvdata[(df_csvdata['Sepsis_SepsisOnset+ShockOnsetOR31h_timeoverlap_exists']==1)& (df_csvdata['Sepsis_SepsisOnset+ShockOnsetOR31h_percentNonMissingData']>=80) ]

print ('shape of the dataframe after we select only icu stays that have all required signals and timeoverlap from CSV : ', df_sepsisOnset_SepsisOnsetPlus31h_csvdata.shape)

icustay_id_list = df_sepsisOnset_SepsisOnsetPlus31h_csvdata['icustay_id']
print('printing only ICU stay IDs to consider', len( icustay_id_list))

# To connect to the mimic DB
import psycopg2
conn = psycopg2.connect(database="mimic",user="postgres",password="postgres",host="localhost", port="5432")
cur = conn.cursor()
cur.execute("SET search_path TO " + "mimiciii")

import pandas.io.sql as psql
try:
  df_AllSepsisOnsetPlus31h_tempdata.drop(df_AllSepsisOnsetPlus31h_tempdata.index, inplace=True)
except:
  print('df_ALL1655_tempdata does not exist')
df_AllSepsisOnsetPlus31h_tempdata = pd.DataFrame(columns=['SUBJECT_ID','ICUSTAY_ID','CHARTTIME','VALUE'])
for icustay_id in icustay_id_list:
  try:
    try:
      df_temp_result.drop(df_temp_result.index, inplace =True)
    except:
      print('df_temp_result does not exist')

    query_getTempData =  """select coh.subject_id, coh.icustay_id,ch.charttime,
       case
         when ch.itemid=223761 then
           (ch.valuenum -32)/1.8
       else
          ch.valuenum
       end as value
        from chartevents ch , sepsis3_cohort coh
        where ch.icustay_id = coh.icustay_id
        and ch.itemid in (223761,223762)
        and ch.error IS DISTINCT FROM 1
        and ch.icustay_id= """ + str(icustay_id) + "order by ch.charttime"; 

    cur.execute(query_getTempData);

    df_temp_result = pd.DataFrame(cur.fetchall(),columns=['SUBJECT_ID','ICUSTAY_ID','CHARTTIME','VALUE'])

    #print(df_temp_result)

    df_AllSepsisOnsetPlus31h_tempdata = df_AllSepsisOnsetPlus31h_tempdata.append(df_temp_result,ignore_index=True)
    print('Appended TEMP data successfully for ICU STAY : ' ,icustay_id )
  
  except:
    print('Error occurred while appending TEMP data for ICU STAY : ' ,icustay_id )

#print(df_ALL1655_tempdata)
#df_ALL1655_tempdata.to_csv

print(df_AllSepsisOnsetPlus31h_tempdata.shape)

df_AllSepsisOnsetPlus31h_tempdata.to_csv('df_236_btwSepsisOnset_ShockOnsetPlus10h_or_SepsisOnsetPlus41h_Patients_LessThan20%Missing_tempdata.csv', sep=',', index = False, header=True);